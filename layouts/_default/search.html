{{ define "header" }}
  {{ partial "basic/header-search.html" . }}
{{ end }}

{{ define "main" }}

<div id="search-block" x-data="searchData">
  <div id="search-header" class="px-24 md:px-64 py-12 bg-blue-600 dark:bg-gray-900 text-gray-100">
    <form @submit.prevent="getResults" class="mt-2 w-1/2 md:w-2/3 relative mx-auto border-2 border-blue-600 dark:border-blue-00 bg-white h-14 rounded-lg text-gray-900 items-center focus:outline-none">
      <input class="w-5/6 ml-5 mt-1 py-1 rounded-lg text-2xl focus:outline-none" id="search-query" name="q" placeholder="검색어를 입력하세요" />
      <button type="submit" class="p-3 float-right">
        <svg class="text-gray-600 h-6 w-6 fill-current" xmlns="http://www.w3.org/2000/svg"
          xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Capa_1" x="0px" y="0px"
          viewBox="0 0 56.966 56.966" style="enable-background:new 0 0 56.966 56.966;" xml:space="preserve"
          width="512px" height="512px">
          <path d="M55.146,51.887L41.588,37.786c3.486-4.144,5.396-9.358,5.396-14.786c0-12.682-10.318-23-23-23s-23,10.318-23,23  s10.318,23,23,23c4.761,0,9.298-1.436,13.177-4.162l13.661,14.208c0.571,0.593,1.339,0.92,2.162,0.92  c0.779,0,1.518-0.297,2.079-0.837C56.255,54.982,56.293,53.08,55.146,51.887z M23.984,6c9.374,0,17,7.626,17,17s-7.626,17-17,17  s-17-7.626-17-17S14.61,6,23.984,6z" />
        </svg>
      </button>
    </form>
  </div>

  <div id="total" class="p-4 mx-6" x-show="results.pagination.total">
    검색 결과: <span x-text="results.pagination.total"></span> 건
  </div>

  <div id="search-contents" class="flex flex-row min-h-screen bg-gray-100 text-gray-800">
    <aside id="search-sidebar" x-show="Object.keys(results.data.aggregations).length" class="sidebar p-8 w-80 md:shadow transform -translate-x-full md:translate-x-0 transition-transform duration-150 ease-in">
      <ul class="flex flex-col w-full">
        <template id="search-facet" x-for="[key, facet] in Object.entries(results.data.aggregations)" :key="key">
          <li class="my-px" x-show="key !== 'culture_workers' && key !== 'tags' && facet.buckets.length > 0">
            <div class="search-facet bg-white border-2 p-6 rounded-lg" :class="'search-facet--' + key">
              <h4 class="border-b-2 pb-2 mb-2" x-text="facet.title"></h4>
              <ul>
              <template id="search-facet-item" x-for="row in facet.buckets">
                <li x-show="row.doc_count > 0">
                  <a href="/search/?q=&facet=[]">
                    <span class="label" x-text="row.key"></span>
                    (<span class="doc-count" x-text="row.doc_count"></span>)
                  </a>
                </li>
              </template>
              </ul>
            </div>
          </li>
        </template>
      </ul>
    </aside>
    <div id="search-results" class="p-4 mb-40 relative mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
      <template id="search-result-template" x-for="item in results.data.items">
        <div class="search_summary w-full p-4">
          <div class="search-item bg-white border-2 p-6 rounded-lg">
            <img class="item-image h-40 w-full rounded object-cover object-center mb-6" :src="item.image" alt="item.title" />
            <h2 class="no-text-decoration text-blue-500 text-base">
              <a class="item-title" :href="item.permalink" x-text="item.title"></a>
            </h2>
            <p class="my-2 item-tags text-sm text-blue-500" x-show="item.tags.toString() != ''">
              <strong class="mr-3" x-text="labels.tags"></strong>
              <template class="terms" x-for="tag in item.tags">
                <a :href="'/tags/'+tag" class="inline-block w-max mr-1 px-2 py-1 bg-white dark:bg-black border-2 border-blue-600 dark:border-blue-500 border box-border rounded-2xl text-sm text-blue-600 dark:text-blue-500 strong" x-text="tag"></a>
              </template>
            </p>
            <p class="my-2 item-creators text-sm" x-show="item.creators.toString() != ''">
              <strong class="mr-3" x-text="labels.creators"></strong>
              <template class="terms" x-for="tag in item.creators">
                <a :href="'/creators/'+tag" class="inline-block w-max mr-1 px-2 py-1 bg-white dark:bg-black border-2 border-blue-600 dark:border-blue-500 border box-border rounded-2xl text-sm text-blue-600 dark:text-blue-500 strong" x-text="tag"></a>
              </template>
            </p>
            <p class="my-2 item-venues text-sm" x-show="item.venues.toString() != ''">
              <strong class="mr-3" x-text="labels.venues"></strong>
              <template class="terms" x-for="tag in item.venues">
                <a :href="'/venues/'+tag" class="inline-block w-max mr-1 px-2 py-1 bg-white dark:bg-black border-2 border-blue-600 dark:border-blue-500 border box-border rounded-2xl text-sm text-blue-600 dark:text-blue-500 strong" x-text="tag"></a>
              </template>
            </p>
            <p class="my-2 item-subjects text-sm" x-show="item.subjects.toString() != ''">
              <strong class="mr-3" x-text="labels.subjects"></strong>
              <template class="terms" x-for="tag in item.subjects">
                <a :href="'/subjects/'+tag" class="inline-block w-max mr-1 px-2 py-1 bg-white dark:bg-black border-2 border-blue-600 dark:border-blue-500 border box-border rounded-2xl text-sm text-blue-600 dark:text-blue-500 strong" x-text="tag"></a>
              </template>
            </p>
            <p class="my-2 item-issues text-sm" x-show="item.issues && item.issues.toString() != ''">
              <strong class="mr-3" x-text="labels.issues"></strong>
              <template class="terms" x-for="tag in item.issues">
                <a :href="'/issues/'+tag" class="inline-block w-max mr-1 px-2 py-1 bg-white dark:bg-black border-2 border-blue-600 dark:border-blue-500 border box-border rounded-2xl text-sm text-blue-600 dark:text-blue-500 strong" x-text="tag"></a>
              </template>
            </p>
            <p class="my-2 item-description text-sm" x-show="item.contents.toString() != ''" x-text="item.contents"></p>
          </div>
        </div>
      </template>
    </div>
  </div>

</div>

<div id="wait" class="flex justify-center absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 items-center hidden">
  <div class="animate-spin rounded-full h-32 w-32 border-b-8 border-blue-500"></div>
</div>

<script>
function searchData() {
  return {
    results: {
      "pagination": {"per_page": 0, "page": 0, "total": 0},
      "data": {"items": [], "aggregations": []},
    },
    labels: JSON.parse('{{ .Site.Params.Vocabularies | jsonify }}'),
    getResults() {
      let query = $('#search-query')[0].value;
      if (query == '') { alert('검색어를 입력하세요.'); return false; }
      document.getElementById('wait').classList.remove('hidden');
      fetch('/api/search/?q=' + query).then(response => response.json())
      .then(results => {
        this.results = results;
      })
      .catch(e => console.error(e))
      .finally(() => {
        document.getElementById('wait').classList.add('hidden');
      })
    }
  }
}
window.addEventListener('DOMContentLoaded', (event) => {
  let $ = document.querySelector.bind(document);
  let find = Element.prototype.querySelectorAll;
  let each = Array.prototype.forEach;
  let on = Node.prototype.addEventListener;
});
</script>
{{ end }}
